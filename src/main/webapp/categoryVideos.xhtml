<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <title>Videos by Category</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
        <h:outputStylesheet name="css/categoryVideosStyle.css"/>
    </h:head>
    <h:body>
        <div class="page-header">
            <h1 class="page-title">âœ¨ Video Gallery</h1>
            <p class="page-subtitle">Discover amazing content in this category</p>
        </div>

        <h:form id="videoForm">
            <div class="video-grid">
                <ui:repeat value="#{userDashboardBean.videosBySelectedCategory}" var="video">
                    <div class="video-card">
                        <div class="thumbnail-container" >
                            <p:graphicImage value="#{video.thumbnailurl}" 
                                            styleClass="thumbnail" 
                                            alt="#{video.title}"/>
                            <div class="duration-badge">#{video.duration}</div>
                            <div class="play-overlay">
                                <!-- Use p:commandLink to trigger dialog -->
                                <p:commandLink styleClass="play-icon-link" 
                                               action="#{userDashboardBean.watchVideoForUser(video)}"
                                               update=":videoForm:videoDialog" 
                                               oncomplete="PF('videoDlg').show()">
                                    <f:setPropertyActionListener value="#{video.videoID}" target="#{userDashboardBean.selectedVideoId}"/>
                                    <div class="play-icon"></div>
                                </p:commandLink>              
                            </div>
                        </div>

                        <div class="card-content">
                            <h3 class="video-title">#{video.title}</h3>
                            <div class="video-stats">
                                <div class="stat-item">
                                    <svg class="stat-icon" viewBox="0 0 20 20">
                                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                                    </svg>
                                    <span>#{userDashboardBean.getLikesForVideo(video.videoID)}</span>
                                </div>
                                <div class="stat-item">
                                    <svg class="stat-icon" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>#{userDashboardBean.getCommentsForVideo(video.videoID).size()}</span>
                                </div>
                                <!-- Views count; assuming video.views is available -->
                                <span class="views-count">#{video.viewscount} views</span>
                            </div>

                            <div class="interaction-bar">
                                <p:commandButton styleClass="like-btn #{userDashboardBean.hasUserLiked(video.videoID) ? 'liked' : ''}"
                                                 icon="#{userDashboardBean.hasUserLiked(video.videoID) ? 'pi pi-heart-fill' : 'pi pi-heart'}"
                                                 action="#{userDashboardBean.likeVideo(video)}"
                                                 update="@form"
                                                 title="#{userDashboardBean.hasUserLiked(video.videoID) ? 'Unlike' : 'Like'}" />

                                <div class="comment-input-container">
                                    <p:inputText styleClass="comment-input"
                                                 placeholder="Add a comment..."
                                                 value="#{userDashboardBean.newCommentTexts[video.videoID]}" />
                                    <p:commandButton styleClass="send-btn"
                                                     icon="pi pi-send"
                                                     action="#{userDashboardBean.addComment(video.videoID)}"
                                                     update="@form"
                                                     title="Post comment" />
                                </div>
                            </div>

                            <div class="comment-section">
                                <ui:repeat value="#{userDashboardBean.getCommentsForVideo(video.videoID)}" var="comment">
                                    <div class="comment">
                                        <span class="comment-author">#{loginBean.getUserById(comment.userID)} : </span>
                                        <span class="comment-text">#{comment.commentText}</span>
                                    </div>
                                </ui:repeat>
                            </div>
                        </div>

                    </div>
                </ui:repeat>
            </div>
            <!-- Video Playback Dialog -->
            <p:dialog id="videoDialog" 
                      widgetVar="videoDlg" 
                      header="#{userDashboardBean.selectedVideo != null ? userDashboardBean.selectedVideo.title : 'Video'}" 
                      modal="true" 
                      dynamic="true" 
                      closable="true" 
                      styleClass="video-dialog"
                      position="center">
                <div class="video-player-container">
                    <h:panelGroup rendered="#{userDashboardBean.selectedVideoId != null}">
                        <video controls="controls" style="width: 100%; max-height: 500px;">
                            <source src="#{request.contextPath}#{userDashboardBean.selectedVideo.videourl}" type="video/mp4"/>
                            Your browser does not support the video tag.
                        </video>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{userDashboardBean.selectedVideo == null}">
                        <p>No video selected.</p>
                    </h:panelGroup>
                </div>
            </p:dialog>
            <!-- Empty state when no videos -->
            <ui:fragment rendered="#{empty userDashboardBean.videosBySelectedCategory}">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“¹</div>
                    <h3>No videos found in this category</h3>
                    <p>Check back later for new content!</p>
                </div>
            </ui:fragment>
        </h:form>
    </h:body>
</html>

